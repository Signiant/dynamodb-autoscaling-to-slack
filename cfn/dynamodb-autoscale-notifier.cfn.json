{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Metadata":{
      "AWS::CloudFormation::Interface":{
         "ParameterGroups":[
            {
               "Label":{
                  "default":"Function Code Location"
               },
               "Parameters":[
                  "FunctionS3Bucket",
                  "FunctionS3Key"
               ]
            },
            {
               "Label":{
                  "default":"Slack Configuration"
               },
               "Parameters":[
                  "SlackApiKey",
                  "SlackChannel"
               ]
            },
            {
               "Label":{
                  "default":"DynamoDB Notifier"
               },
               "Parameters":[
                  "TableFilter"
               ]
            }
         ]
      }
   },
   "Parameters":{
      "FunctionS3Bucket":{
         "Type":"String",
         "Default":"",
         "Description":"S3 bucket containing the Lambda function zip file"
      },
      "FunctionS3Key":{
         "Type":"String",
         "Default":"",
         "Description":"S3 key within the bucket for the function (ie. folder/foo.zip)"
      },
      "SlackApiKey":{
         "Type":"String",
         "Default":"",
         "Description":"Valid Slack API Key (obtain by creating a bot)"
      },
      "SlackChannel":{
         "Type":"String",
         "Default":"#general",
         "Description":"Slack Channel to post scaling notifications to"
      },
      "TableFilter":{
         "Type":"String",
         "Default":"",
         "Description":"Only post scaling notifications for tables that match the table filter regular expression"
      }
   },
   "Resources":{
      "FunctionRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "Path":"/dynamodb/autoscale/",
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Policies":[
               {
                  "PolicyName":"DynamoDBAutoscalingNotify",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Sid":"Logging",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Effect":"Allow",
                           "Resource":"arn:aws:logs:*:*:*:*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "AutoscaleNotifySlackFunction":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "FunctionName":"DynamoDBAutoScalingSlackNotifier",
            "Description":"Notify in Slack when autoscaling actions occur",
            "Role":{
               "Fn::GetAtt":[
                  "FunctionRole",
                  "Arn"
               ]
            },
            "Runtime":"python2.7",
            "Handler":"dynamodb-as-notify-slack.lambda_handler",
            "MemorySize":128,
            "Timeout":20,
            "Environment":{
               "Variables":{
                  "slack_api_token":{
                     "Ref":"SlackApiKey"
                  },
                  "slack_channel":{
                     "Ref":"SlackChannel"
                  },
                  "table_filter": {
                     "Fn::If": [
                        "HasTableFilter",
                        {
                           "Ref": "TableFilter"
                        },
                        {
                           "Ref": "AWS::NoValue"
                        }
                     ]
                  }
               }
            },
            "Code":{
               "S3Bucket":{
                  "Ref":"FunctionS3Bucket"
               },
               "S3Key":{
                  "Ref":"FunctionS3Key"
               }
            }
         }
      },
      "UpdateTableRule":{
         "Type":"AWS::Events::Rule",
         "Properties":{
            "Description":"Triggered when dynamoDB autoscaling updates a table",
            "Name":"DynamoDBAutoscaleUpdateTableEvent",
            "State":"ENABLED",
            "EventPattern":{
               "source":[
                  "aws.dynamodb"
               ],
               "detail":{
                  "userAgent":[
                     "application-autoscaling.amazonaws.com"
                  ],
                  "eventName":[
                     "UpdateTable"
                  ]
               }
            },
            "Targets":[
               {
                  "Arn":{
                     "Fn::GetAtt":[
                        "AutoscaleNotifySlackFunction",
                        "Arn"
                     ]
                  },
                  "Id":"AutoscaleNotifySlack"
               }
            ]
         }
      },
      "LambdaInvokePermission":{
         "Type":"AWS::Lambda::Permission",
         "Properties":{
            "Action":"lambda:InvokeFunction",
            "FunctionName":{
               "Fn::GetAtt":[
                  "AutoscaleNotifySlackFunction",
                  "Arn"
               ]
            },
            "Principal":"events.amazonaws.com",
            "SourceArn":{
               "Fn::GetAtt":[
                  "UpdateTableRule",
                  "Arn"
               ]
            }
         }
      }
   },
   "Conditions": {
      "HasTableFilter": {
         "Fn::Not": [
            {
               "Fn::Equals": [
                  "",
                  {
                     "Ref": "TableFilter"
                  }
               ]
            }
         ]
      }
   }
}
